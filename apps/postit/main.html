<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Postit</title>
  <link rel="stylesheet" href="/postit/styles/jquery-ui.css">
  <script src="/postit/scripts/jquery.js"></script>
  <script src="/postit/scripts/jquery-ui.js"></script>
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0-rc4/angular-material.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>
  <!-- Angular Material Library -->
  <script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0-rc4/angular-material.min.js"></script>
  <style>
body, html { height: 100%; }
.draggable { width: 150px; height: 150px; padding: 0.5em; border: 1px solid}

  </style>
</head>
<body>
  <div id="control">
    <div ng-app="posts" id="postits">
      <div ng-controller="dialogCtrl" class="md-padding" ng-cloak>
	<md-button class="md-primary md-raised" ng-click="showDialog($event)">
	  Create
	</md-button>
      </div>
      
      <div ng-controller="postsCtrl" ng-cloak>
	<div ng-repeat="post in posts" class="draggable" onload="load()">
	  <div>State {{post.state.name}}</div>
	  <div>{{post.note}}</div>
	  <div>Created by {{post.user.username}}</div>
	  <div>Created at {{post.creationDate | date:'medium'}}</div>
	</div>
      </div>
      
    </div>
  </div>
  <script><!--
var posts = angular.module('posts', ['ngMaterial', 'ngMessages']);
posts.controller('postsCtrl', function($scope, $http, $rootScope) {
  // maybe we just want to append the result.
  $rootScope.$on("reload", function() {
    $scope.load();
  });
  $scope.load = function() {
    $http.get("/postit/load-postit")
         .then(
            function(response) {
              $scope.posts = response.data;
            },
            function(response) {
              $scope.posts = [];
            });
  };
  $scope.load();// is there a better way?
});

posts.controller('dialogCtrl', function($scope, $mdDialog, $rootScope, $http) {

  $scope.showDialog = function(ev) {
    $mdDialog.show({
      controller: DialogController,
      templateUrl: '/postit/templates/post.tmpl.html',
      parent: angular.element(document.body),
      targetEvent: ev,
      clickOutsideToClose: true
    }).then(function(note) {
      var data = "username=anonymous&note=" + encodeURIComponent(note);
      $http({
        method: 'POST',
	url: "/postit/create-postit",
	headers: {'Content-Type': 'application/x-www-form-urlencoded'},
	data: data
      }).then(
        function() {
          $rootScope.$emit("reload", {});
        }
      );
    });
  };
})

function DialogController($scope, $mdDialog) {
  $scope.hide = function() { $mdDialog.hide(); };
  $scope.cancel = function() { $mdDialog.cancel(); };
  $scope.create = function() {
    $mdDialog.hide($scope.note); 
  };
}
--></script>
</body>
</html>

