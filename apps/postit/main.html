<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Postit</title>
  <link rel="stylesheet" href="/postit/styles/jquery-ui.css">
  <script src="/postit/scripts/jquery.js"></script>
  <script src="/postit/scripts/jquery-ui.js"></script>
  <style>
    body, html { height: 100%; }
    .draggable { width: 150px; height: 150px; padding: 0.5em; border: 1px solid}
    fieldset { padding:0; border:0; margin-top:25px; }
    label, input { display:block; }
    label, select { display:inline; }
  </style>
  <script type="text/javascript">
    <!--
	function save_position(event, ui) {
	  // ajax.get (ui.id, ui.position.top, ui.position.left)
	  var id = $(this).attr('id');
	  var p = ui.position;
	  jQuery.ajax("/postit/update-position", {
	    type: "POST",
	    data: { "id": id, "top": p.top, "left": p.left},
	  });	  
	}
	function save_size(event, ui) {
	  // ajax.get (ui.id, ui.size.width, ui.size.height)
	  var id = $(this).attr('id');
	  var p = ui.size;
	  jQuery.ajax("/postit/update-size", {
	    type: "POST",
	    data: { "id": id, "width": p.width, "height": p.height},
	  });
	}
	function remove_postit(event) {
	  var id = $(this).attr('postit');
	  jQuery.ajax("/postit/remove-postit", {
	    type: "POST",
	    data: {"id": id},
	  });
	  $("#" + id).remove();
	}
	function decimal_to_rgbhex(i) {
	  var hex = i.toString(16);
	  var remain = 6-hex.length;
	  for (var i = 0; i < remain; i++) hex = '0' + hex;
	  return "#" + hex;
	}
	function load_colors(id) {
	  jQuery.ajax("/postit/colors", {
	    success: function(data, status, jqXHR) {
	      var colors = $("#" + id);
	      colors.empty();
	      for (var i = 0; i < data.length; i++) {
	        var option = jQuery("<option>", {
		  "value": data[i].id,
		  "style": "background-color:" + decimal_to_rgbhex(data[i].rgb)
		}).append(data[i].name);
		colors.append(option);
	      }
	    }
	  });
	}
	function load_postit() {
	  jQuery.ajax("/postit/load-postit", {
	    success: function(data, status, jqXHR) {
	      // datum must have the followings
	      // id, note, top, left, width, height, 
	      // text-color, background-color, creation-date
	      var area = $("#postits");
	      area.empty();

	      for (var i = 0; i < data.length; i++) {
	        var style = "top:" + data[i].top + "px;";
		style += "left:" + data[i].left + "px;";
		style += "width:" + data[i].width + "px;";
		style += "height:" + data[i].height + "px;";
		style += "background-color:" + decimal_to_rgbhex(data[i].backgroundColor) + ";";

		var d = new Date(data[i].creationDate);
		var date = jQuery("<div/>", {
		  "style": "bottom: 0px; position: absolute;"
		}).append("Created on: ")
		  .append(d.toLocaleDateString())
		  .append(" ")
		  .append(d.toLocaleTimeString());
		var close = jQuery("<a>", {
		  "href": "javascript:void(0)",
		  "class": "ui-icon ui-icon-circle-close",
		  "style": "position: absolute; top: 0px; right:0px",
		  "postit": data[i].id,
		}).on("click", remove_postit);
		var note = jQuery("<div>", {
		  "style": "color:" + decimal_to_rgbhex(data[i].textColor) + ";"
		}).append(data[i].note);
		      
	        var div = jQuery("<div/>", {
		  "id":      data[i].id,
		  "class":   "draggable",
		  "style":   style
		}).append(note)
		  .append(close)
		  .append(date)
		  .on("click", function(event) {
		    $(".draggable").css({"z-index": 10});
		    $(this).css({"z-index": 100});
		  })
		  .appendTo(area);
	      }
	      
	      $(".draggable").draggable({
                stop: save_position,
		containment: "parent"
	      }).resizable({
	        stop: save_size,
	      }); 
	    }
	  });
	}

	$(function() {
	  var dialog, form;
	  function postit() {
	    var note = $("#note").val();
	    var username = "anonymous"; // for now
	    var tc = $("#text-colors").val();
	    var bg = $("#bg-colors").val();

	    jQuery.ajax("/postit/create-postit", {
	      type: "POST",
	      data: { "note": note, 
		      "username" : username, 
		      "text-color-id": tc,
		      "bg-color-id": bg},
	      success: load_postit // argument will be ignored
	    });
	    dialog.dialog("close");
	  }
	  dialog = $("#dialog").dialog({
	    autoOpen: false,
	    height: 500,
	    width: 550,
	    modal: true,
	    buttons: {
	      "Post It": postit,
	      Cancel: function() { dialog.dialog("close"); }
	    },
	    close: function() { form[0].reset(); }
	  });
	  
	  form = dialog.find("form").on("submit", function(event) {
	    event.preventDefault();
	    postit();
	  });
	  $("#new-postit").button().on("click", function() {
	    dialog.dialog("open");
	  });
	  load_postit();
	  load_colors("text-colors");
	  load_colors("bg-colors");
	});
      -->
  </script>
</head>
<body>
  <div id="control" style="float: left; width: 10%;">
    <div id="dialog" title="New">
      <form action="#">
	<fieldset>
	  <div style="width: 100%; position: relative;">
	    <div style="float:left; width: 80%;">
	      <label for="name">Note</label>
	      <textarea id="note" name="note"
		        class="text" cols="30" rows="10"></textarea>
	      <input type="submit" tabindex="-1" class="postit"
		     style="position:absolute; top:-1000px">
	    </div>
	    <div style="float:right; width: 20%;">
	      <label for="name">Font colors</label>
	      <select id="text-colors" name="text-colors"></select>
	      <select id="bg-colors" name="bg-colors"></select>
	    </div>
	  </div>
	</fieldset>
      </form>
    </div>
    <button id="new-postit">Create</button>
  </div>

  <div id="postits" style="float: right; width: 90%; height: 100%;">
  </div>
</body>
</html>

